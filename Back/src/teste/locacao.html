<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
    crossorigin="anonymous"></script>
  <script>
    let infoProduto = sessionStorage.getItem("infosEscolhidas");
    infoProduto = JSON.parse(infoProduto)
    console.log(infoProduto);
  </script>
  <title>Criar Locação</title>
  <style>
    * {
      padding: 0;
    }

    div,
    body {
      display: flex;
      flex-direction: column;
    }

    .row {
      flex-direction: row;
    }

    .column {
      flex-direction: column;
    }

    .space-10 {
      margin-bottom: 10px;
    }

    .space-20 {
      margin-bottom: 20px;
    }

    .space-40 {
      margin-bottom: 40px;
    }

    .space-right-20 {
      margin-right: 20px;
    }

    .box {
      width: 200px;
      height: 20px;
    }

    .align-center {
      align-items: center;
    }

    td {
      border: 1px solid #000000;
    }

    .centralizado {
      text-align: center;
    }

    /* .box-esquerda {
      width: 30%;
      margin-right: 5%;
    }

    .box-direita {
      width: 65%;
    } */
  </style>
</head>

<body>
  <div class="box-esquerda">
    <h1>Criar locação</h1>

    <div class="row space-10 align-center">
      <p class="space-right-20">Data Locada:</p>
      <input disabled class="box" type="text" name="data-locada">
    </div>

    <div class="row space-10 align-center">
      <div>
        <p class="space-right-20">Data Devolução:</p>
        <input disabled class="box" type="text" name="data-devolucao">
      </div>
      <div>
        <button onclick="adicionarMaisUmaSemana()">Adicionar mais 1 semana</button>
      </div>
    </div>

    <div class="row space-10 align-center">
      <p class="space-right-20">Locação Preço:</p>
      <input disabled class="box" type="text" name="preco">
    </div>
    
    <div class="row space-10 align-center">
      <p class="space-right-20">Cliente ID:</p>
      <input disabled value="4" class="box" type="text" name="cliente-id">
    </div>

    <button id="cadastrar-livro" onclick="enviarParaBack()">Locar</button>
  </div>

  <div class="box-direita">
    <h1 class="space-40">Livros selecinoados</h1>
    <table class="space-20">
      <tr>
        <td class="centralizado" colspan="10">Livros selecionados</td>
      </tr>
      <tr>
        <td class="centralizado">Título</td>
        <td class="centralizado">Autor</td>
        <td class="centralizado">Gêneros</td>
        <td class="centralizado">Descrição</td>
        <td class="centralizado">Lançamento</td>
        <td class="centralizado">Ediçao</td>
        <td class="centralizado">Páginas</td>
      </tr>
    </table>
  </div>

  <script>
    function preencheForm() {
      precoForm();

      dataForm();
    }

    function precoForm() {
      // preenche parte do preço
      let preco = 5.50
      if (infoProduto.length > 1) {
        preco += (infoProduto.length - 1) * 4;
      }

      document.getElementsByName("preco")[0].value = `R$ ${preco.toFixed(2)}`;
    }

    function dataForm() {
      // preenche data de devolução
      let dataLocada = new Date();
      dataLocada = dataLocada.toLocaleDateString();
      document.getElementsByName("data-locada")[0].value = dataLocada;

      // tempo fixo + tempo por livro adicional
      const tempoPadrao = 5 + (infoProduto.length - 1) * 7;
      let dataDevolucao = tempo(dataLocada, tempoPadrao);
      document.getElementsByName("data-devolucao")[0].value = dataDevolucao;
    }

    function adicionarMaisUmaSemana() {
      let dataDevolucao = document.getElementsByName("data-devolucao")[0].value;
      dataDevolucao = tempo(dataDevolucao, 7);
      document.getElementsByName("data-devolucao")[0].value = dataDevolucao;

      let preco = document.getElementsByName("preco")[0].value;
      console.log(preco);
      preco = (parseFloat(preco.slice(3)) + 5.5).toFixed(2);
      document.getElementsByName("preco")[0].value = `R$ ${preco}`;
    }

    function tempo(data, tempo) {
      let dia = parseInt(data.slice(0, 2));
      let mes = parseInt(data.slice(3, 5));
      let ano = parseInt(data.slice(6));

      dia += tempo;

      let meses = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]

      if (ano % 4 == 0) {
        meses[1] = 29
      }

      if (dia > meses[mes - 1]) {
        dia -= meses[mes - 1];
        mes++;
      }

      if (mes > 12) {
        ano++;
        mes -= 12;
      }

      return ("0" + dia).slice(-2) + "/" + ("0" + mes).slice(-2) + "/" + ano;
    }

    preencheForm();

    function enviarParaBack() {
      let dataLocada = document.getElementsByName("data-locada")[0].value;
      dataLocada = dataLocada.slice(6) + "-" + dataLocada.slice(3, 5) + "-" + dataLocada.slice(0, 2);

      let dataDevolucao = document.getElementsByName("data-devolucao")[0].value;
      dataDevolucao = dataDevolucao.slice(6) + "-" + dataDevolucao.slice(3, 5) + "-" + dataDevolucao.slice(0, 2);

      let produtoId = []

      for (let i = 0; i < infoProduto.length; i++) {
        produtoId.push(infoProduto[i][0][0].idProduto);
      }

      console.log(produtoId);

      let locacao = {
        locacaoMulta: 0,
        locacaoPreco: document.getElementsByName("preco")[0].value.slice(3),
        dataDevolucao: dataDevolucao,
        dataLocada: dataLocada,
        locacaoEstado: "locado",
        clienteId: document.getElementsByName("cliente-id")[0].value,
        produtoId: produtoId
      }

      $.post("/locacao",
        {
          locacao
        },
        function (data, status) {
          console.log(data.data);
        }
      )
    }
  </script>
</body>

</html>